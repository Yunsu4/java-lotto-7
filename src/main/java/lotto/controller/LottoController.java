package lotto.controller;

import java.util.List;
import lotto.model.Lotto;
import lotto.model.LottoBonusNumber;
import lotto.model.LottoCount;
import lotto.service.LottoService;
import lotto.util.InputValidator;
import lotto.util.WinningDetails;
import lotto.view.InputView;
import lotto.view.OutputView;

public class LottoController {

    private final InputView inputView;
    private final OutputView outputView;
    private final InputValidator inputValidator;
    private final LottoService lottoService;


    public LottoController(InputView inputView, OutputView outputView,
                           InputValidator inputValidator, LottoService lottoService) {
        this.inputView = inputView;
        this.outputView = outputView;
        this.inputValidator = inputValidator;
        this.lottoService = lottoService;
    }

    public void run() {
        int lottoCount = getPurchasedLottoCount();

        List<Lotto> autoGeneratedLottos = getAutoGeneratedLottos(lottoCount);

        Lotto lottoNumbers = getLottoNumbers();
        Integer bonusNumber = getLottoBonusNumber(lottoNumbers);

        lottoService.determineWinningDetails(autoGeneratedLottos, lottoNumbers, bonusNumber);

        printWinningDetails();
        printRateOfReturn(lottoCount);
    }


    private int getPurchasedLottoCount() {
        int lottoCount = getLottoCount();
        outputView.printPurchasedLottoCount(lottoCount);
        return lottoCount;
    }

    private int getLottoCount() {
        String purchaseAmount = inputView.enteredPurchaseAmount();

        try {
            LottoCount lottoCount = new LottoCount(purchaseAmount, inputValidator);
            return lottoCount.getLottoCount();
        } catch (IllegalArgumentException e) {
            System.out.println(e.getMessage());
            return getLottoCount();
        }
    }

    private List<Lotto> getAutoGeneratedLottos(int lottoCount) {
        List<Lotto> autoGeneratedLottos = lottoService.generateLottos(lottoCount);
        String collectedAutoGeneratedLottos = collectAutoGeneratedLottos(autoGeneratedLottos);
        outputView.printAutoGeneratedLotto(collectedAutoGeneratedLottos);
        return autoGeneratedLottos;
    }

    private String collectAutoGeneratedLottos(List<Lotto> autoGeneratedLottos) {
        StringBuilder collectedAutoGeneratedLotto = new StringBuilder();
        for (Lotto autoGeneratedLotto : autoGeneratedLottos) {
            String numbersOfOneLotto = autoGeneratedLotto.getLottoNumbers().toString();
            collectedAutoGeneratedLotto.append(numbersOfOneLotto);
            collectedAutoGeneratedLotto.append("\n");
        }
        return collectedAutoGeneratedLotto.toString();
    }

    private Lotto getLottoNumbers() {
        String lottoNumbers = inputView.enteredLottoNumbers();

        try {
            return lottoService.parseLottoNumbers(lottoNumbers);
        } catch (IllegalArgumentException e) {
            System.out.println(e.getMessage());
            return getLottoNumbers();
        }
    }

    private Integer getLottoBonusNumber(Lotto lottoNumbers) {
        String bonusNumber = inputView.enteredLottoBonusNumber();

        try {
            LottoBonusNumber lottoBonusNumber = new LottoBonusNumber(bonusNumber, lottoNumbers, inputValidator);
            return lottoBonusNumber.getLottoBonusNumber();
        } catch (IllegalArgumentException e) {
            System.out.println(e.getMessage());
            return getLottoBonusNumber(lottoNumbers);
        }
    }

    private void printWinningDetails() {
        outputView.startPrintWinning();

        for (WinningDetails winningDetail : WinningDetails.getWinningDetails()) {
            int sameNumberCount = winningDetail.getSameNumberCount();
            String winningPrize = winningDetail.getWinningPrize();
            int matchLottoCount = winningDetail.getMatchLottoCount();
            boolean matchBonus = winningDetail.getMatchBonusNumber();
            outputView.printWinningDetails(sameNumberCount, winningPrize, matchLottoCount, matchBonus);
        }
    }

    private void printRateOfReturn(int lottoCount) {
        String yield = lottoService.calculateYield(lottoCount);
        outputView.printYield(yield);
    }
}
